# 仅仅打开了1个页面，为什么有4个进程？
# 线程 VS 进程
线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率

- 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
- 线程之间共享进程中的数据。
- 当一个进程关闭之后，操作系统会回收进程所占用的内存。
- 进程之间的内容相互隔离。
> 联想到为什么js是单线程，可以把DOM CSSOM理解成渲染进程上的数据，而js线程也运行在渲染进程上，如果js是多线程的话，当多个线程同时对进程数据进行读写操作，那么势必会造成数据混乱，所以，js设计成单线程的。


# 单进程浏览器问题

## 不稳定
 插件等崩溃后导出整个浏览器的崩溃，一些复杂的 JavaScript 代码就有可能引起渲染引擎模块的崩溃。和插件一样，渲染引擎的崩溃也会导致整个浏览器的崩溃。 

## 不流畅 
所有页面的渲染模块、JavaScript 执行环境以及插件都是运行在同一个线程中的，这就意味着同一时刻只能有一个模块可以执行

## 不安全
如果是单进程浏览器架构，插件和页面脚本可以通过漏洞对接操作系统，但是浏览器本身有些功能是需要对接到操作系统的，比如文件下载等

# 早期多进程架构

## 解决不稳定
进程是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或者插件进程，并不会影响到浏览器和其他页面

## 解决不流畅
JavaScript 也是运行在渲染进程中的，所以即使 JavaScript 阻塞了渲染进程，影响到的也只是当前的渲染页面，而并不会影响浏览器和其他页面，因为其他页面的脚本是运行在它们自己的渲染进程中的。<br />对于内存泄漏的解决方法那就更简单了，因为当关闭一个页面时，整个渲染进程也会被关闭，之后该进程所占用的内存都会被系统回收，这样就轻松解决了浏览器页面的内存泄漏问题。

## 解决安全问题
采用多进程架构的额外好处是可以使用安全沙箱，你可以把沙箱看成是操作系统给进程上了一把锁，沙箱里面的程序可以运行，但是不能在你的硬盘上写入任何数据，也不能在敏感位置读取任何数据

# 目前多进程架构
![image.png](../../assets/1646813729248-17e89f9e-dbf0-4c8c-9f63-608b93f0b03a.png)
最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

- **浏览器进程**。主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。
- **渲染进程**。核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。
- **GPU 进程**。其实，Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程。
- **网络进程**。主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。
- **插件进程**。主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

## 问题

- **更高的资源占用**。因为每个进程都会包含公共基础结构的副本（如 JavaScript 运行环境），这就意味着浏览器会消耗更多的内存资源。
- **更复杂的体系架构**。浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求了。

# 未来面向服务的架构
为了解决这些问题，在 2016 年，Chrome 官方团队使用“面向服务的架构”（Services Oriented Architecture，简称 SOA）的思想设计了新的 Chrome 架构。<br />原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统
> 理解：以前是每个页面需要若干进程完成各自的工作，现在是将各个页面通用的功能（视频、网络、渲染等）发布为系统服务，页面在需要的时候与相应的服务通信完成需要的功能。这起码把进程间的耦合从页面中分离出去了。

![image.png](../../assets/1646814751939-cf5df113-2b01-4b53-b268-c9ba47e9c152.png)
同时 Chrome 还提供灵活的弹性架构，在强大性能设备上会以多进程的方式运行基础服务，但是如果在资源受限的设备上（如下图），Chrome 会将很多服务整合到一个进程中，从而节省内存占用。
![image.png](../../assets/1646814820144-ba76f611-abb9-4082-8ba2-8694650baeb4.png)

# 问题：

## 即使是如今的多进程架构，我偶尔还会碰到一些由于单个页面卡死最终崩溃导致所有页面崩溃的情况，请问这是什么原因呢
通常情况下是一个页面使用一个进程，但是，有一种情况，叫"同一站点(same-site)"，具体地讲，我们将“同一站点”定义为根域名（例如，geekbang.org）加上协议（例如，https:// 或者http://），还包含了该根域名下的所有子域名和不同的端口，比如下面这三个：

https://time.geekbang.org<br />https://www.geekbang.org<br />https://www.geekbang.org:8080<br />都是属于同一站点，因为它们的协议都是https，而根域名也都是geekbang.org。你也许了解同源策略，但是同一站点和同源策略还是存在一些不同地方，在这里你需要了解它们不是同一件事就行了。

Chrome的默认策略是，每个标签对应一个渲染进程。但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫process-per-site-instance。

直白的讲，就是如果几个页面符合同一站点，那么他们将被分配到一个渲染进程里面去。

所以，这种情况下，一个页面崩溃了，会导致同一站点的页面同时崩溃，因为他们使用了同一个渲染进程。

为什么要让他们跑在一个进程里面呢？

因为在一个渲染进程里面，他们就会共享JS的执行环境，也就是说A页面可以直接在B页面中执行脚本。因为是同一家的站点，所以是有这个需求的。

## 单进程浏览器开多个页面，渲染线程也只有一个吗？感觉一个页面开一个线程不是更合理吗？
我们从IE6开始讲起，IE6时代，浏览器是单进程的，所有页面也都是运行在一个主线程中的，当时IE6就是这样设计，而且此时的IE6是单标签，也就是说一个页面一个窗口。

这时候，国内有很多国产浏览器，都是基于IE6来二次开发的，而IE6原生架构就是所有页面跑在单线程里面的，意味着，所有的页面都共享着同一套JavaScript运行环境，同样，对于存储Cookie也都是在一个线程里面操作的。<br />而且这些国产浏览器由于需要，都采用多标签的形式，所以其中的一个标签页面的卡顿都会影响到整个浏览器。

基于卡顿的原因，国内浏览器就开始尝试支持页面多线程，也就是让部分页面运行在单独的线程之中，运行在单独的线程之中，意味着每个线程拥有单独的JavaScript执行环境，和Cookie环境，这时候问题就来了：<br />比如A站点页面登陆一个网站，保存了一些Cookie数据到磁盘上，再在当前线程环境中保存部分Session数据，由于Session是不需要保存到硬盘上的，所以Session只会保存在当前的线程环境中。这时候再打开另外一个A站点的页面，假设这个页面在另外一个线程中里面，那么它首先读取硬盘上的Cookie信息，但是，由于Session信息是保存在另外一个线程里面的，无法直接读取，这样就要实现一个Session同步的问题，由于IE并没有源代码，所以实现起来非常空难，国内浏览器花了好长一点时间才解决这个问题的。

Session问题解决了，但是假死的问题依然有，因为进程内使用了一个窗口，这个窗口是依附到浏览器主窗口之上的，所以他们公用一套消息循环机制，消息循环我们后面会详细地讲，这也就意味这一个窗口如果卡死了。也会导致整个浏览器的卡死。

国产浏览器又出了一招，就是把页面做成一个单独的弹窗，如果这个页面卡死了，就把这个弹窗给隐藏掉。

这里还要提一下为什么Chrome中的一个页面假死不会影响到主窗口呢？<br />这是因为chrome输出的实际上图片，然后浏览器端把图片贴到自己的窗口上去，在Chrome的渲染进程内，并没有一个渲染窗口，输出的只是图片，如果卡住了，顶多图片不更新了。

国产浏览器这一套技术花了四五年时间，等这套技术差不多成熟时，Chrome发布了 :(

## 如果打开了 2个页面，会有几个进程呢？是 1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 2个渲染进程，共 5个吗？这些进程是可以在浏览器开发者中被实际观察到的吗？
通常情况下会是五个，但是有很多其他情况：<br />1:如果页面里有iframe的话，iframe也会运行在单独的进程中！<br />2:如果页面里有插件，同样插件也需要开启一个单独的进程！<br />3:如果你装了扩展的话，扩展也会占用进程<br />4:如果2个页面属于同一站点的话，并且从a页面中打开的b页面，那么他们会公用一个渲染进程

这些进程都可以通过chrome的任务管理器来查看。

# 总结
早期浏览器：<br />不稳定（单独进程）<br />不流畅（单独进程）<br />不安全（沙箱）

早期多进程架构：<br />主进程 渲染进程 插件进程

现代多进程架构：<br />主进程 渲染进程 插件进程 GPU进程 网络进程

未来：<br />面向服务架构<br /><!--!><br />1.打开一个页面，chrome启动 4个 进程；<br />准确的说是， 最少四个<br />主进程+网络进程+GPU进程+渲染进程；<br />开启了插件还有更多的插件进程；

2.最新的 Chrome 浏览器的进程包括：五种<br />（1）1 个浏览器（Browser）主进程<br />界面显示、用户交互、子进程管理，存储功能；

（2）1 个网络（NetWork）进程：<br />网络资源加载；

（3）1 个 GPU 进程：<br />绘制UI界面；

（4）多个渲染进程<br />将HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，<br />渲染引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，<br />默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。<br />出于安全考虑，渲染进程都是运行在沙箱模式下，不能获取系统权限对硬盘进行读写等；

> 注意：
> 1. 同一站点 的tab页共用一个渲染进程<br />新页面会复用父页面的渲染进程。<br />官方把这个默认策略叫 process-per-site-instance。<br />“同一站点”跟同源策略的定义一样，协议、域名、端口都要相同；
> 
> 2.渲染进程包含很多个子线程：<br />有合成线程（Compositor），合成图块栅格化线程（Compositor Tile Worker），和主线程。


（5）多个插件进程<br />插件易崩溃，做一个隔离，免得影响整个页面；

3.目前架构的两个问题<br />（1）更高的资源占用。<br />（2）更复杂的体系结构；

4.未来的发展<br />（）“面向服务的架构”（Services Oriented Architecture，简称 SOA）<br />学习操作系统的架构，原来的各种模块会被重构成独立的服务（Service），每个在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统

# 参考文章
《浏览器工作原理与实践》 --李兵<br />[浏览器一个Tab对应一个渲染进程？浏览器渲染进程个数究竟与什么有关系](https://blog.csdn.net/wangfeijiu/article/details/106609953)
[从浏览器多进程到JS单线程，JS运行机制最全面的一次梳理](https://www.cnblogs.com/cangqinglang/p/8963557.html)

